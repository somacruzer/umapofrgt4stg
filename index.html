<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMAP Cluster Analysis Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-morphism {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .shadow-soft {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .plotly-container {
            border-radius: 12px;
            overflow: hidden;
        }
        .filter-chip {
            transition: all 0.2s ease;
        }
        .filter-chip:hover {
            transform: translateY(-1px);
        }
        .stats-card {
            background: linear-gradient(145deg, #f8fafc, #e2e8f0);
            border-left: 4px solid #667eea;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Data processing functions
        const processData = (rawData) => {
            const processed = rawData.map(row => ({
                userId: row['User_ID'],
                surveyId: row['Survey_ID'],
                surveyName: row['Survey_Name'] || 'Unknown Survey',
                poleA: row['Pole_A'] || '',
                poleB: row['Pole_B'] || '',
                cluster: parseInt(row['Cluster']),
                x: parseFloat(row['Coordinate_X']),
                y: parseFloat(row['Coordinate_Y']),
                bipolarConstruct: row['Bipolar_Construct'] || '',
                clusterSize: parseInt(row['Cluster_Size'])
            }));
            return processed;
        };

        const getClusterStats = (data) => {
            const clusters = {};
            data.forEach(point => {
                if (!clusters[point.cluster]) {
                    clusters[point.cluster] = {
                        id: point.cluster,
                        count: 0,
                        users: new Set(),
                        surveys: new Set(),
                        constructs: []
                    };
                }
                clusters[point.cluster].count++;
                clusters[point.cluster].users.add(point.userId);
                clusters[point.cluster].surveys.add(point.surveyName);
                if (point.bipolarConstruct) {
                    clusters[point.cluster].constructs.push(point.bipolarConstruct);
                }
            });
            
            return Object.values(clusters).map(cluster => ({
                ...cluster,
                users: cluster.users.size,
                surveys: Array.from(cluster.surveys),
                topConstructs: [...new Set(cluster.constructs)].slice(0, 3)
            }));
        };

        const getSurveyStats = (data) => {
            const surveys = {};
            data.forEach(point => {
                if (!surveys[point.surveyName]) {
                    surveys[point.surveyName] = {
                        name: point.surveyName,
                        count: 0,
                        users: new Set(),
                        clusters: new Set()
                    };
                }
                surveys[point.surveyName].count++;
                surveys[point.surveyName].users.add(point.userId);
                surveys[point.surveyName].clusters.add(point.cluster);
            });
            
            return Object.values(surveys).map(survey => ({
                ...survey,
                users: survey.users.size,
                clusters: Array.from(survey.clusters).sort((a, b) => a - b)
            }));
        };

        // Main Dashboard Component
        const Dashboard = () => {
            const [data, setData] = useState([]);
            const [filteredData, setFilteredData] = useState([]);
            const [selectedClusters, setSelectedClusters] = useState(new Set());
            const [selectedSurveys, setSelectedSurveys] = useState(new Set());
            const [searchTerm, setSearchTerm] = useState('');
            const [viewMode, setViewMode] = useState('all'); // all, clusters, surveys
            const [isLoading, setIsLoading] = useState(true);
            const [clusterStats, setClusterStats] = useState([]);
            const [surveyStats, setSurveyStats] = useState([]);
            const plotRef = useRef(null);

            useEffect(() => {
                loadData();
            }, []);

            useEffect(() => {
                applyFilters();
            }, [data, selectedClusters, selectedSurveys, searchTerm, viewMode]);

            useEffect(() => {
                if (filteredData.length > 0) {
                    createPlot();
                }
            }, [filteredData]);

            const loadData = async () => {
                try {
                    const response = await fetch('constructs_cluster_dataset.csv');
                    const csvText = await response.text();
                    const parsedData = parseCSV(csvText);
                    const processedData = processData(parsedData);
                    
                    setData(processedData);
                    setFilteredData(processedData);
                    setClusterStats(getClusterStats(processedData));
                    setSurveyStats(getSurveyStats(processedData));
                    setIsLoading(false);
                } catch (error) {
                    console.error('Error loading data:', error);
                    setIsLoading(false);
                }
            };

            const parseCSV = (csvText) => {
                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                return lines.slice(1).map(line => {
                    const values = line.split(',').map(v => v.trim().replace(/^"(.*)"$/, '$1'));
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    return row;
                });
            };

            const applyFilters = () => {
                let filtered = [...data];

                if (selectedClusters.size > 0) {
                    filtered = filtered.filter(point => selectedClusters.has(point.cluster));
                }

                if (selectedSurveys.size > 0) {
                    filtered = filtered.filter(point => selectedSurveys.has(point.surveyName));
                }

                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filtered = filtered.filter(point => 
                        point.bipolarConstruct.toLowerCase().includes(term) ||
                        point.poleA.toLowerCase().includes(term) ||
                        point.poleB.toLowerCase().includes(term) ||
                        point.surveyName.toLowerCase().includes(term)
                    );
                }

                setFilteredData(filtered);
            };

            const createPlot = () => {
                if (!plotRef.current) return;

                const colors = [
                    '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57',
                    '#FF9FF3', '#54A0FF', '#5F27CD', '#00D2D3', '#FF9F43'
                ];

                const traces = [];
                const uniqueClusters = [...new Set(filteredData.map(d => d.cluster))].sort();

                // Add cluster traces
                uniqueClusters.forEach((cluster, index) => {
                    const clusterData = filteredData.filter(d => d.cluster === cluster);
                    
                    const hoverText = clusterData.map(d => 
                        `<b>User:</b> ${d.userId.substring(0, 8)}...<br>` +
                        `<b>Cluster:</b> ${d.cluster}<br>` +
                        `<b>Survey:</b> ${d.surveyName}<br>` +
                        `<b>Construct:</b> ${d.bipolarConstruct}<br>` +
                        `<b>Coordinates:</b> (${d.x.toFixed(2)}, ${d.y.toFixed(2)})`
                    );

                    traces.push({
                        x: clusterData.map(d => d.x),
                        y: clusterData.map(d => d.y),
                        mode: 'markers',
                        type: 'scatter',
                        name: `Cluster ${cluster} (${clusterData.length} points)`,
                        marker: {
                            color: colors[index % colors.length],
                            size: 8,
                            opacity: 0.8,
                            line: {
                                width: 1,
                                color: 'white'
                            }
                        },
                        text: hoverText,
                        hovertemplate: '%{text}<extra></extra>',
                        visible: true
                    });
                });

                const layout = {
                    title: {
                        text: 'UMAP Cluster Visualization',
                        font: { size: 24, color: '#2D3748' },
                        x: 0.5
                    },
                    xaxis: {
                        title: 'UMAP Dimension 1',
                        showgrid: true,
                        gridcolor: '#E2E8F0',
                        zeroline: false
                    },
                    yaxis: {
                        title: 'UMAP Dimension 2',
                        showgrid: true,
                        gridcolor: '#E2E8F0',
                        zeroline: false
                    },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: '#FFFFFF',
                    hovermode: 'closest',
                    showlegend: true,
                    legend: {
                        orientation: 'v',
                        yanchor: 'top',
                        y: 1,
                        xanchor: 'left',
                        x: 1.02,
                        bgcolor: 'rgba(255,255,255,0.9)',
                        bordercolor: '#E2E8F0',
                        borderwidth: 1
                    },
                    margin: { l: 60, r: 200, t: 80, b: 60 }
                };

                const config = {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d'],
                    displaylogo: false
                };

                Plotly.newPlot(plotRef.current, traces, layout, config);
            };

            const toggleCluster = (clusterId) => {
                const newSelected = new Set(selectedClusters);
                if (newSelected.has(clusterId)) {
                    newSelected.delete(clusterId);
                } else {
                    newSelected.add(clusterId);
                }
                setSelectedClusters(newSelected);
            };

            const toggleSurvey = (surveyName) => {
                const newSelected = new Set(selectedSurveys);
                if (newSelected.has(surveyName)) {
                    newSelected.delete(surveyName);
                } else {
                    newSelected.add(surveyName);
                }
                setSelectedSurveys(newSelected);
            };

            const resetFilters = () => {
                setSelectedClusters(new Set());
                setSelectedSurveys(new Set());
                setSearchTerm('');
                setViewMode('all');
            };

            if (isLoading) {
                return (
                    <div className="min-h-screen flex items-center justify-center gradient-bg">
                        <div className="text-center text-white">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"></div>
                            <h2 className="text-2xl font-semibold mb-2">Loading Data</h2>
                            <p className="text-lg opacity-80">Processing UMAP cluster visualization...</p>
                        </div>
                    </div>
                );
            }

            const uniqueClusters = [...new Set(data.map(d => d.cluster))].sort();
            const uniqueSurveys = [...new Set(data.map(d => d.surveyName))].sort();

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="gradient-bg text-white py-8">
                        <div className="container mx-auto px-4">
                            <h1 className="text-4xl font-bold mb-2">UMAP Cluster Analysis Dashboard</h1>
                            <p className="text-xl opacity-90">Interactive exploration of construct clustering patterns</p>
                        </div>
                    </header>

                    {/* Stats Overview */}
                    <div className="container mx-auto px-4 py-8">
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div className="stats-card p-6 rounded-lg shadow-soft">
                                <h3 className="text-sm font-semibold text-gray-600 uppercase tracking-wider">Total Data Points</h3>
                                <p className="text-3xl font-bold text-gray-800 mt-2">{data.length.toLocaleString()}</p>
                            </div>
                            <div className="stats-card p-6 rounded-lg shadow-soft">
                                <h3 className="text-sm font-semibold text-gray-600 uppercase tracking-wider">Unique Users</h3>
                                <p className="text-3xl font-bold text-gray-800 mt-2">{new Set(data.map(d => d.userId)).size}</p>
                            </div>
                            <div className="stats-card p-6 rounded-lg shadow-soft">
                                <h3 className="text-sm font-semibold text-gray-600 uppercase tracking-wider">Clusters</h3>
                                <p className="text-3xl font-bold text-gray-800 mt-2">{uniqueClusters.length}</p>
                            </div>
                            <div className="stats-card p-6 rounded-lg shadow-soft">
                                <h3 className="text-sm font-semibold text-gray-600 uppercase tracking-wider">Surveys</h3>
                                <p className="text-3xl font-bold text-gray-800 mt-2">{uniqueSurveys.length}</p>
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="glass-morphism rounded-xl p-6 mb-8 shadow-soft">
                            <div className="flex flex-wrap items-center gap-4 mb-6">
                                <div className="flex-1 min-w-64">
                                    <input
                                        type="text"
                                        placeholder="Search constructs, poles, or surveys..."
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>
                                <button
                                    onClick={resetFilters}
                                    className="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                                >
                                    Reset Filters
                                </button>
                            </div>

                            {/* Cluster Filters */}
                            <div className="mb-6">
                                <h3 className="text-lg font-semibold text-gray-800 mb-3">Filter by Clusters</h3>
                                <div className="flex flex-wrap gap-2">
                                    {uniqueClusters.map(cluster => {
                                        const isSelected = selectedClusters.has(cluster);
                                        const clusterInfo = clusterStats.find(s => s.id === cluster);
                                        return (
                                            <button
                                                key={cluster}
                                                onClick={() => toggleCluster(cluster)}
                                                className={`filter-chip px-4 py-2 rounded-full text-sm font-medium transition-all ${
                                                    isSelected 
                                                        ? 'bg-blue-500 text-white shadow-lg' 
                                                        : 'bg-white text-gray-700 border border-gray-300 hover:border-blue-300'
                                                }`}
                                            >
                                                Cluster {cluster} ({clusterInfo?.count || 0})
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Survey Filters */}
                            <div>
                                <h3 className="text-lg font-semibold text-gray-800 mb-3">Filter by Surveys</h3>
                                <div className="flex flex-wrap gap-2">
                                    {uniqueSurveys.map(survey => {
                                        const isSelected = selectedSurveys.has(survey);
                                        const surveyInfo = surveyStats.find(s => s.name === survey);
                                        return (
                                            <button
                                                key={survey}
                                                onClick={() => toggleSurvey(survey)}
                                                className={`filter-chip px-4 py-2 rounded-full text-sm font-medium transition-all ${
                                                    isSelected 
                                                        ? 'bg-green-500 text-white shadow-lg' 
                                                        : 'bg-white text-gray-700 border border-gray-300 hover:border-green-300'
                                                }`}
                                            >
                                                {survey} ({surveyInfo?.count || 0})
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>

                        {/* Visualization */}
                        <div className="glass-morphism rounded-xl p-6 shadow-soft">
                            <div className="plotly-container" ref={plotRef} style={{ height: '600px' }}></div>
                        </div>

                        {/* Statistics Tables */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                            {/* Cluster Statistics */}
                            <div className="glass-morphism rounded-xl p-6 shadow-soft">
                                <h3 className="text-xl font-bold text-gray-800 mb-4">Cluster Statistics</h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b border-gray-200">
                                                <th className="text-left py-2 px-3">Cluster</th>
                                                <th className="text-left py-2 px-3">Points</th>
                                                <th className="text-left py-2 px-3">Users</th>
                                                <th className="text-left py-2 px-3">Surveys</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {clusterStats.map(cluster => (
                                                <tr key={cluster.id} className="border-b border-gray-100">
                                                    <td className="py-2 px-3 font-medium">{cluster.id}</td>
                                                    <td className="py-2 px-3">{cluster.count}</td>
                                                    <td className="py-2 px-3">{cluster.users}</td>
                                                    <td className="py-2 px-3">{cluster.surveys.length}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {/* Survey Statistics */}
                            <div className="glass-morphism rounded-xl p-6 shadow-soft">
                                <h3 className="text-xl font-bold text-gray-800 mb-4">Survey Statistics</h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b border-gray-200">
                                                <th className="text-left py-2 px-3">Survey</th>
                                                <th className="text-left py-2 px-3">Points</th>
                                                <th className="text-left py-2 px-3">Users</th>
                                                <th className="text-left py-2 px-3">Clusters</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {surveyStats.map(survey => (
                                                <tr key={survey.name} className="border-b border-gray-100">
                                                    <td className="py-2 px-3 font-medium text-xs">{survey.name}</td>
                                                    <td className="py-2 px-3">{survey.count}</td>
                                                    <td className="py-2 px-3">{survey.users}</td>
                                                    <td className="py-2 px-3">{survey.clusters.length}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>
